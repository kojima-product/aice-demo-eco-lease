# 積算AI 処理フロー詳細

## 概要

このドキュメントでは、AI見積生成システムの処理フローを詳細に説明します。

---

## 全体処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    仕様書PDF アップロード                          │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: テキスト抽出                                              │
│   - PyPDF2でPDFからテキスト抽出                                    │
│   - PyMuPDFで図面・画像抽出（オプション）                           │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 建物情報抽出（LLM）                                        │
│   - Claude APIで構造化データに変換                                 │
│   - 抽出項目: 工事名、場所、面積、階数、部屋数、リース期間           │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2.5: 諸元表抽出（Vision API）                                 │
│   - PDFの39-40ページを画像化                                       │
│   - Claude Vision APIで表を構造化                                  │
│   - 部屋ごとのガス栓数、コンセント数を取得                          │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 見積項目生成（LLM）                                        │
│   - 工事区分別に専門プロンプトを使用                                │
│   - KB語彙リストを含めてマッチング精度向上                          │
│   - 数量推定ルールに基づく数量算出                                  │
│   - 信頼度スコア付与                                               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3.5: チェックリスト検証                                       │
│   - 工事区分別必須項目との照合                                      │
│   - カバー率70%未満の場合、不足項目を自動追加                       │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: KBマッチング（単価付与）                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ Phase 1: ベクトル検索（FAISS + sentence-transformers）    │   │
│   │   - 項目名をベクトル化                                    │   │
│   │   - 類似度上位5件を取得                                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ Phase 2: 文字列マッチング（フォールバック）               │   │
│   │   - 類義語辞書（166語）で展開                            │   │
│   │   - 完全一致 +2.0、部分一致 +1.0、仕様一致 +1.0          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                          │                                       │
│                          ▼                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 検証フェーズ                                             │   │
│   │   - 単位互換性チェック（「式」vs「m」等）                 │   │
│   │   - 高額一式項目チェック（500万円超は完全一致必須）       │   │
│   │   - 単価妥当性チェック（最低/最大価格）                   │   │
│   └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 5: 金額計算                                                  │
│   - 子項目 → 親項目の順で計算（逆順処理）                          │
│   - 親項目 = 子項目の合計                                          │
│   - 単価 × 数量 = 金額                                            │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 6: 妥当性検証                                                │
│   - ㎡単価チェック（建物タイプ別の期待範囲）                        │
│   - 異常値検出・警告                                               │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 7: FMTDocument生成                                           │
│   - 構造化された見積データ                                         │
│   - メタデータ（チェックリスト結果、検証結果）                      │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 8: 出力                                                      │
│   - PDF見積書                                                     │
│   - Excel見積書（根拠情報付き）                                    │
│   - JSON（機械可読形式）                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 主要コンポーネント

### 1. AIEstimateGenerator クラス

**ファイル**: `pipelines/estimate_generator_ai.py`

```python
class AIEstimateGenerator:
    def __init__(self):
        self.client = Anthropic()  # Claude API
        self.price_kb = self._load_price_kb()  # KB読み込み
        self.vector_index = self._build_vector_index()  # FAISS索引
```

**主要メソッド**:

| メソッド | 説明 |
|---------|------|
| `extract_text_from_pdf()` | PDFからテキスト抽出 |
| `extract_building_info()` | LLMで建物情報を構造化 |
| `extract_specification_table_with_vision()` | Vision APIで諸元表を解析 |
| `generate_detailed_items_for_gas()` | ガス設備項目を生成 |
| `generate_detailed_items_for_electrical()` | 電気設備項目を生成 |
| `generate_detailed_items_for_mechanical()` | 機械設備項目を生成 |
| `enrich_with_prices()` | KBから単価を付与 |

### 2. KBマッチングロジック

**ファイル**: `pipelines/estimate_generator_ai.py` (enrich_with_prices)

#### マッチングスコア計算

```python
score = 0.0

# 1. 項目名一致
if item_name == kb_description:
    score += 2.0  # 完全一致
elif item_name in kb_description or kb_description in item_name:
    score += 1.0  # 部分一致

# 2. 仕様一致
if item_spec == kb_spec:
    score += 1.0  # 完全一致
elif item_spec in kb_spec or kb_spec in item_spec:
    score += 0.5  # 部分一致

# 3. 単位一致
if item_unit == kb_unit:
    score += 0.5

# 正規化（0-1スケール）
normalized_score = min(score / 5.0, 1.0)
```

#### マッチング閾値

| 閾値 | 説明 |
|------|------|
| ≥ 0.8 | 高信頼度マッチ |
| ≥ 0.5 | 中信頼度マッチ |
| ≥ 0.3 | 低信頼度マッチ（フォールバック） |
| < 0.3 | マッチなし |

### 3. 類義語辞書

**現在の語数**: 166語

**例**:
```python
SYNONYM_DICT = {
    "高圧ケーブル": ["CVケーブル", "CVT", "CV", "6600V", "架橋ポリエチレン"],
    "LED照明": ["LED", "LED器具", "照明器具", "LEDベースライト"],
    "白ガス管": ["鋼管", "ガス管", "SGP", "配管用炭素鋼鋼管"],
    ...
}
```

### 4. KB（ナレッジベース）

**ファイル**: `kb/price_kb.json`

**現在の項目数**: 2,074件

| 工事区分 | 項目数 |
|---------|--------|
| 機械設備工事 | 801件 |
| 電気設備工事 | 727件 |
| 衛生設備工事 | 325件 |
| ガス設備工事 | 107件 |
| 空調設備工事 | 62件 |
| 消防設備工事 | 52件 |

**KB項目の構造**:
```json
{
  "item_id": "GAS_EXT_001",
  "description": "白ガス管(ネジ接合)",
  "discipline": "ガス設備工事",
  "unit": "m",
  "unit_price": 8990.0,
  "features": {
    "specification": "15A",
    "quantity": 1.0
  }
}
```

---

## 検証・フィルタリング機能

### 1. 単位互換性チェック

異なる単位タイプ間のマッチングを防止:

```python
# 互換性なしの例
- 「式」 ↔ 「m」
- 「台」 ↔ 「個」
- 「箇所」 ↔ 「m」
```

### 2. 高額一式項目チェック

500万円超の「式」単価は完全一致のみ許可:

```python
if kb_item.get("requires_exact_match"):
    return False  # 完全一致でないため拒否
```

### 3. 単価妥当性チェック

高額機器の最低価格・一般項目の最大価格をチェック:

```python
HIGH_VALUE_ITEMS = {
    "キュービクル": 800000,  # 最低80万円
    "変圧器": 300000,        # 最低30万円
    "発電機": 1500000,       # 最低150万円
}

MAX_PRICE_ITEMS = {
    "コンセント": 30000,     # 最大3万円
    "照明器具": 80000,       # 最大8万円
}
```

---

## 実行例

### コマンドライン

```bash
# デバッグツールでマッチング状況を確認
python3 debug_matching.py

# KB正規化
python3 normalize_kb.py

# KB拡充
python3 expand_kb.py
```

### Streamlit UI

```bash
streamlit run app.py
```

---

## 改善履歴

| 日付 | 改善内容 | 効果 |
|------|---------|------|
| 2026-01-14 | プロンプトから過剰生成指示を削除 | 項目数の適正化 |
| 2026-01-14 | プロンプトにKB語彙リストを追加 | マッチング精度向上 |
| 2026-01-14 | KB半角カタカナ正規化 | 194件 → 0件 |
| 2026-01-14 | 「同上」項目の親項目継承 | 113件 → 0件 |
| 2026-01-14 | 類義語辞書拡充 | 100語 → 166語 |
| 2026-01-14 | KB拡充 | 1,953件 → 2,074件 |
| 2026-01-14 | ガス設備KB拡充 | 51件 → 107件 |

---

---

## KB構築プロセスの問題点

### 問題1: LLM抽出時の品質問題

KB構築時（`pipelines/kb_builder.py`）にLLMでPDFから抽出する際、以下の問題が発生:

| 問題 | 原因 | 対策 |
|------|------|------|
| **「同上」項目の未解決** | LLMが文脈を理解できない | プロンプトに明示的な指示を追加済み |
| **工事区分の誤分類** | キーワード判定の不備 | 分類ルールを追加（93件修正） |
| **重複項目** | 複数見積書のマージ時 | 統合ロジックを追加（146件統合） |
| **仕様の欠落** | 元データに記載なし | 推測補完ロジックを検討中 |

### 問題2: PDF抽出の精度

```
元PDF → PyPDF2テキスト抽出 → LLM構造化 → KB
         ↓
    テキストが取れない場合
         ↓
    OCR（Claude Vision API）→ LLM構造化 → KB
```

**OCR時の問題**:
- 表形式の認識精度が低い
- 金額の桁区切り（¥1,234,567）の誤認識
- 仕様欄の読み取り漏れ

### 問題3: KB品質の継続的な劣化

新しい見積書をKBに追加する際:
- 既存項目との重複チェックが不十分
- 工事区分の一貫性が保てない
- 一時的なIDが残存

### 改善策

1. **KB構築前のバリデーション**
   ```python
   # 追加前に品質チェック
   if not validate_kb_item(item):
       logger.warning(f"Skipping invalid item: {item}")
       continue
   ```

2. **定期的なKBクリーニング**
   ```bash
   python3 improve_kb_quality.py
   ```

3. **KB構築時のプロンプト改善**
   - 仕様欄の明示的な抽出指示
   - サイズ・型番の正規化ルール
   - 工事区分の判定基準を詳細化

---

## 今後の改善方向

1. **ベクトル検索モデルの改善**
   - 日本語専用モデル `cl-tohoku/bert-base-japanese` への変更
   - 見積専用モデルのFine-tuning

2. **KB継続拡充**
   - 空調設備: 62件 → 150件
   - 消防設備: 52件 → 100件

3. **仕様マッチング精度向上**
   - サイズ別（15A、20A等）の精度向上
   - 数量推定ルールの精緻化

4. **KB構築プロセスの改善**
   - 抽出時のバリデーション強化
   - 定期的な品質チェック自動化
   - 重複検出・統合の自動化
