# 積算AIシステム 処理フロー分析・問題点可視化

## 1. 現在の処理フロー全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         仕様書PDF (入力)                                     │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: テキスト抽出 (PyPDF2)                                               │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 全ページをテキスト化 (約40,000〜60,000文字)                               │
│ • ページ番号マーカーを追加                                                  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: 建物情報抽出 (Claude LLM)                                           │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 工事名、場所、顧客、面積、階数、部屋数                                    │
│ • 設備要件（ガス/電気/機械の有無・仕様）                                    │
│ • 工事条件（既存建物、解体要否、作業制限）                                  │
│                                                                             │
│ 【出力例】                                                                  │
│   project_name: "都立山崎高等学校 仮設校舎等の借入れ"                       │
│   total_floor_area: 2145 ㎡                                                 │
│   floors: 2                                                                 │
│   num_rooms: 20 (推定)                                                      │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌───────────────────────────────┐ ┌───────────────────────────────────────────┐
│ STEP 2.5: 諸元表抽出          │ │ STEP 2.6: Vision抽出 (Claude Vision)      │
│ (テキストベース)               │ │ (画像認識)                                 │
├───────────────────────────────┤ ├───────────────────────────────────────────┤
│ • 部屋一覧表のテキスト解析    │ │ • PDFを画像化して表を認識                 │
│ • 設備数量のカウント          │ │ • より正確な数量データ取得                │
│ • 精度: 低〜中               │ │ • 精度: 高                                 │
└───────────────┬───────────────┘ └───────────────┬───────────────────────────┘
                │                               │
                └───────────────┬───────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌───────────────────────────────┐ ┌───────────────────────────────────────────┐
│ STEP 2.7: 図面抽出            │ │      (マージされた建物情報)               │
│ (Claude Vision)               │ │                                           │
├───────────────────────────────┤ │ • 部屋数: 122室 (Vision抽出)              │
│ • 配置図、設備図を画像解析    │ │ • ガス栓: 8箇所                           │
│ • 配管ルート、機器位置        │ │ • コンセント: 374個                       │
│ • 配管延長の推定              │ │ • 面積: 2,145㎡                           │
└───────────────┬───────────────┘ └───────────────────────────────────────────┘
                │
                └───────────────────────────────┐
                                                │
                                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: 見積項目生成 (Claude LLM)                                           │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 工事区分別にプロンプトで項目生成                                          │
│ • 数量推定ルールに基づいて数量を算出                                        │
│ • 階層構造 (Level 0-2) で出力                                               │
│                                                                             │
│ 【ガス設備の場合のプロンプト例】                                            │
│   "白ガス管の配管延長 = ガス栓数 × 15〜25m"                                 │
│   "配管支持金物 = 配管延長 ÷ 1.5m"                                          │
│                                                                             │
│ 【生成される項目例】                                                        │
│   L0: ガス設備工事 (式)                                                     │
│   L1: 配管工事費 (式)                                                       │
│     L2: 白ガス管 15A - 100m                                                 │
│     L2: 白ガス管 20A - 50m                                                  │
│     L2: ガス栓 - 8箇所                                                      │
│   L1: 付帯工事費 (式)                                                       │
│     L2: 配管撤去 - 1式                                                      │
│     L2: 諸経費 - 1式                                                        │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3.5: チェックリスト検証                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 工事区分ごとのチェックリストと比較                                        │
│ • カバー率70%未満なら不足項目を自動追加                                     │
│                                                                             │
│ 【チェックリスト項目数】                                                    │
│   電気設備: 36項目 (8カテゴリ)                                              │
│   機械設備: 30項目 (8カテゴリ)                                              │
│   ガス設備: 21項目 (5カテゴリ)                                              │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: 単価マッチング (KB検索)                                  ★ 問題箇所 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                             │
│ 【マッチング方式】                                                          │
│   1. ベクトル検索 (FAISS + sentence-transformers) ← 優先                   │
│   2. 文字列マッチング (類義語辞書 + 正規化) ← フォールバック               │
│                                                                             │
│ 【マッチング条件】                                                          │
│   • 工事区分の互換性チェック                                                │
│   • 単位の互換性チェック (式 vs m は不可)                                   │
│   • 単価妥当性チェック (高額機器の最低価格)                                 │
│   • スコア >= 0.3 で単価を適用                                              │
│                                                                             │
│ 【現在のKB状況】                                                            │
│   総項目数: 1,953件                                                         │
│   電気設備: 697件 | 機械設備: 766件 | ガス設備: 51件                        │
│                                                                             │
│ ❌ 問題1: 項目名の表記ゆれ                                                  │
│   AI生成: "白ガス管（ネジ接合）"                                            │
│   KB登録: "白ガス管（ﾈｼﾞ接合）" または "SGP" または "ガス配管"              │
│                                                                             │
│ ❌ 問題2: 仕様の不一致                                                      │
│   AI生成: "15A" → KBに "15A" がない場合、類似の "20A" にマッチ             │
│   結果: 誤った単価が適用される                                              │
│                                                                             │
│ ❌ 問題3: KBの項目不足                                                      │
│   ガス設備: 51件のみ (全体の2.6%)                                           │
│   必要な項目がKBにない → 単価なし (マッチング失敗)                          │
│                                                                             │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: 金額計算                                                            │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 金額 = 数量 × 単価                                                        │
│ • 親項目 = 子項目の合計                                                     │
│ • 逆順処理（子→親の順で計算）                                              │
│                                                                             │
│ 【計算例】                                                                  │
│   白ガス管 15A: 100m × ¥8,990/m = ¥899,000                                  │
│   ガス栓: 8箇所 × ¥35,000/箇所 = ¥280,000                                   │
│   配管工事費 = ¥899,000 + ¥280,000 + ... = ¥2,500,000                       │
│                                                                             │
│ ❌ 問題: 単価がマッチしないと金額=0                                         │
│   マッチング率50% → 金額が実際の半分程度になる                              │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 6: FMTDocument生成 + 出力                                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ • 見積書PDF生成                                                             │
│ • Excel出力（根拠情報付き）                                                 │
│ • 質疑ドラフト生成（信頼度 < 0.8 の項目）                                   │
│ • 法令根拠リスト                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 問題点の詳細分析

### 2.1 KBの問題

| 問題 | 詳細 | 影響度 |
|------|------|--------|
| **項目数の偏り** | ガス51件 vs 電気697件 vs 機械766件 | ★★★ 高 |
| **単位の不統一** | 「〃」285件、「ケ所」と「ヶ所」が別 | ★★ 中 |
| **単価の範囲が広い** | ¥243 〜 ¥8,000,000 | ★★ 中 |
| **仕様の表記ゆれ** | "15A" vs "15a" vs "15Φ" | ★★★ 高 |

#### 現在のKB統計

```
■ 工事区分別項目数:
  機械設備工事: 766件 (39.2%)
  電気設備工事: 697件 (35.7%)
  衛生設備工事: 325件 (16.6%)
  空調設備工事: 62件 (3.2%)
  消防設備工事: 52件 (2.7%)
  ガス設備工事: 51件 (2.6%)  ← 最も少ない

■ 単位別項目数 (上位10):
  m: 427件 | 〃: 285件 | ヶ所: 212件 | 式: 202件
  ケ所: 144件 | 個: 134件 | 台: 132件 | 面: 117件
```

### 2.2 マッチングの問題

```
【マッチング失敗の例】

AI生成項目            KBの項目               問題
────────────────────────────────────────────────────────────
"高圧気中開閉器"   → "気中開閉器" or "PAS"   → 類義語辞書にあるが一部マッチ失敗
"架橋ポリエチレン"  → "CV" or "CVT"          → 略称との変換が不十分
"LED照明器具"       → "照明器具（LED）"      → 語順の違い
"配管支持金物"      → "支持金物（SUS）"      → 材質指定の有無
"穴あけ工事"        → "穴補修" or "貫通"    → 作業内容の表現差
```

### 2.3 数量推定の問題

```
【推定ルールの限界】

仕様書の記載              推定ルール              実際の必要数量
────────────────────────────────────────────────────────────
"ガス栓 設置"          → 推定: 建物規模から計算   → 仕様書に数量なし → 過大/過小推定
"配管工事 一式"        → 推定: 面積×係数         → 実際の配管ルートは不明
"照明器具 適切に配置"   → 推定: 面積÷30㎡/台     → 実際の配灯計画は不明
```

---

## 3. 精度が上がらない根本原因

### 原因1: AIの項目名とKBの項目名が一致しない

```
┌─────────────────────┐      ┌─────────────────────┐
│     AI生成          │      │    ナレッジベース    │
│  (自然言語ベース)   │ ≠≠≠ │  (過去見積ベース)    │
├─────────────────────┤      ├─────────────────────┤
│ "白ガス管（ネジ）"  │      │ "白ｶﾞｽ管（ﾈｼﾞ）"   │
│ "高圧ケーブル"      │      │ "CV 38sq"           │
│ "LED照明"           │      │ "照明器具（LED型）" │
└─────────────────────┘      └─────────────────────┘
         ↓
   類義語辞書で変換
         ↓
   それでもマッチしない項目が多い
```

### 原因2: 仕様書に詳細情報がない

```
仕様書の記載レベル:
  "都市ガス設備 一式"
  "電気設備工事 一式"
  "空調設備 適宜設置"

必要な詳細レベル:
  "白ガス管 15A 100m"
  "白ガス管 20A 50m"
  "分電盤 主幹100A 3面"
  "LED照明 40W型 120台"
```

### 原因3: KBのカバレッジ不足

```
KBにある項目: 1,953件
必要な項目: 推定 5,000件以上

不足しているカテゴリ:
  - 仮設工事（足場、養生、安全設備）
  - 試験調整（気密試験、絶縁試験）
  - 諸経費の詳細（現場管理費、安全対策費）
  - 特殊工事（高所作業、夜間作業）
```

---

## 4. 改善提案

### 即効性のある改善（1週間以内）

| 改善項目 | 内容 | 期待効果 |
|----------|------|----------|
| **KB項目名の正規化** | 全角→半角、略称統一、仕様フォーマット統一 | マッチング率 +10〜20% |
| **類義語辞書の拡充** | 現在約100語 → 300語以上に | マッチング率 +5〜10% |
| **AI生成プロンプトにKB語彙を指定** | KBの項目名リストをプロンプトに含める | マッチング率 +15〜25% |

### 中期的な改善（1ヶ月以内）

| 改善項目 | 内容 | 期待効果 |
|----------|------|----------|
| **KBの拡充** | ガス設備を51件→200件以上に | マッチング率 +20〜30% |
| **ベクトル検索の日本語最適化** | multilingual-e5 → 日本語専用モデル | マッチング精度向上 |
| **参照見積書からの学習** | 過去見積をKBに自動登録 | KBカバレッジ向上 |

### 長期的な改善

| 改善項目 | 内容 | 期待効果 |
|----------|------|----------|
| **Fine-tuning** | 見積専用モデルの構築 | 精度 +30〜40% |
| **図面AI解析** | 配管ルート・機器位置の自動読取 | 数量精度向上 |
| **類似案件検索** | 過去の類似プロジェクトとの比較 | 妥当性検証 |

---

## 5. 現在の精度指標

### マッチング率の目安

```
現状の推定マッチング率:
  電気設備: 60〜70% (KB豊富)
  機械設備: 55〜65% (KB豊富)
  ガス設備: 40〜50% (KB不足)

目標マッチング率:
  全工事区分: 85%以上
```

### 金額精度の目安

```
マッチング率と金額精度の関係:
  マッチング率 50% → 金額精度 約50%（半分の項目に単価なし）
  マッチング率 70% → 金額精度 約70%
  マッチング率 90% → 金額精度 約85%（推定数量の誤差含む）
```

---

## 6. デバッグ・確認方法

### ログの確認場所

```bash
# 最新のログを確認
tail -f logs/estimate_*.log

# マッチング結果を確認
grep "✓ Match" logs/estimate_*.log  # 成功
grep "✗ No match" logs/estimate_*.log  # 失敗
```

### KB項目の検索

```python
# 特定の項目がKBにあるか確認
import json
with open('kb/price_kb.json') as f:
    kb = json.load(f)

# 検索例
keyword = "白ガス管"
matches = [item for item in kb if keyword in item.get('description', '')]
print(f"{keyword}: {len(matches)}件")
for m in matches[:5]:
    print(f"  - {m['description']} ({m['unit']}) @¥{m['unit_price']:,}")
```

---

## 7. まとめ

**精度が上がらない最大の原因は「AI生成項目名とKB項目名のギャップ」**です。

これを解決するには:
1. **短期**: プロンプトにKB語彙を明示的に含める
2. **中期**: KBを拡充し、正規化を徹底する
3. **長期**: 見積専用の言語モデルを構築する

現在のシステムは「処理フローは正しい」が「データ（KB）が不足」している状態です。
