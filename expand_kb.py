#!/usr/bin/env python3
"""
KB拡充スクリプト

不足している項目を追加:
1. ガス設備: 配管撤去、穴補修、継手類、サイズ別配管
2. 電気設備: LED照明、変圧器、LAN配線
3. 機械設備: 冷媒配管、給排水管、衛生器具
"""

import json
from pathlib import Path
from datetime import datetime

def load_kb():
    """KBを読み込み"""
    with open('kb/price_kb.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def save_kb(kb_items):
    """KBを保存"""
    with open('kb/price_kb.json', 'w', encoding='utf-8') as f:
        json.dump(kb_items, f, ensure_ascii=False, indent=2)

def get_next_id(kb_items, prefix):
    """次のIDを取得"""
    max_num = 0
    for item in kb_items:
        item_id = item.get('item_id', '')
        if item_id.startswith(prefix):
            try:
                num = int(item_id.split('_')[-1])
                max_num = max(max_num, num)
            except:
                pass
    return f"{prefix}_{max_num + 1:03d}"

def create_kb_item(item_id, description, discipline, unit, unit_price, specification="", quantity=1.0):
    """KB項目を作成"""
    return {
        "item_id": item_id,
        "description": description,
        "discipline": discipline,
        "unit": unit,
        "unit_price": unit_price,
        "vendor": None,
        "valid_from": datetime.now().strftime("%Y-%m-%d"),
        "valid_to": None,
        "source_project": "KB拡充スクリプト",
        "context_tags": ["追加項目"],
        "features": {
            "specification": specification,
            "quantity": quantity
        },
        "similarity_score": 0.0
    }

def add_gas_equipment(kb_items):
    """ガス設備項目を追加"""
    print("\n■ ガス設備項目を追加中...")

    new_items = [
        # 配管撤去
        ("配管撤去", "ガス設備工事", "m", 1500, "既設白ガス管"),
        ("配管撤去", "ガス設備工事", "m", 1800, "既設カラー鋼管"),
        ("配管撤去工事", "ガス設備工事", "式", 85000, "一式"),

        # 穴補修
        ("穴補修", "ガス設備工事", "箇所", 3500, "モルタル充填"),
        ("穴補修", "ガス設備工事", "箇所", 5500, "防火区画"),
        ("貫通スリーブ", "ガス設備工事", "箇所", 2800, "鋼管スリーブ"),

        # 白ガス管（サイズ別）
        ("白ガス管(ネジ接合)", "ガス設備工事", "m", 7500, "10A"),
        ("白ガス管(ネジ接合)", "ガス設備工事", "m", 9800, "25A"),
        ("白ガス管(ネジ接合)", "ガス設備工事", "m", 12500, "32A"),
        ("白ガス管(ネジ接合)", "ガス設備工事", "m", 15800, "40A"),
        ("白ガス管(ネジ接合)", "ガス設備工事", "m", 22000, "65A"),

        # カラー鋼管（サイズ別）
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 8500, "15A"),
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 9500, "20A"),
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 11500, "25A"),
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 14000, "32A"),
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 18000, "40A"),
        ("カラー鋼管(ネジ接合)", "ガス設備工事", "m", 25000, "50A"),

        # PE管（サイズ別）
        ("PE管", "ガス設備工事", "m", 7800, "20A"),
        ("PE管", "ガス設備工事", "m", 11000, "40A"),
        ("PE管", "ガス設備工事", "m", 15500, "50A"),
        ("PE管", "ガス設備工事", "m", 22000, "75A"),
        ("PE管", "ガス設備工事", "m", 28000, "100A"),

        # フレキ管
        ("フレキ管", "ガス設備工事", "m", 4500, "15A"),
        ("フレキ管", "ガス設備工事", "m", 5500, "20A"),

        # 継手類
        ("エルボ", "ガス設備工事", "個", 850, "15A"),
        ("エルボ", "ガス設備工事", "個", 1200, "20A"),
        ("エルボ", "ガス設備工事", "個", 1800, "25A"),
        ("チーズ", "ガス設備工事", "個", 1100, "15A"),
        ("チーズ", "ガス設備工事", "個", 1500, "20A"),
        ("チーズ", "ガス設備工事", "個", 2200, "25A"),
        ("レデューサー", "ガス設備工事", "個", 950, "20A×15A"),
        ("レデューサー", "ガス設備工事", "個", 1400, "25A×20A"),
        ("ユニオン", "ガス設備工事", "個", 1800, "15A"),
        ("ユニオン", "ガス設備工事", "個", 2500, "20A"),

        # バルブ
        ("ボールバルブ", "ガス設備工事", "個", 3500, "15A"),
        ("ボールバルブ", "ガス設備工事", "個", 4800, "20A"),
        ("ボールバルブ", "ガス設備工事", "個", 6500, "25A"),
        ("ゲートバルブ", "ガス設備工事", "個", 4200, "15A"),
        ("ゲートバルブ", "ガス設備工事", "個", 5800, "20A"),

        # ガス栓追加
        ("ネジコック", "ガス設備工事", "個", 4500, "15A"),
        ("ネジコック", "ガス設備工事", "個", 6200, "20A"),
        ("分岐コック", "ガス設備工事", "個", 8500, "25A×15A"),
        ("分岐コック", "ガス設備工事", "個", 12000, "32A×20A"),
        ("ヒューズコック", "ガス設備工事", "個", 5500, "15A"),

        # 支持金物
        ("配管支持金具", "ガス設備工事", "個", 650, "15A用"),
        ("配管支持金具", "ガス設備工事", "個", 850, "25A用"),
        ("配管支持金具", "ガス設備工事", "個", 1200, "50A用"),
        ("配管支持金具", "ガス設備工事", "式", 45000, "一式"),

        # 試験・諸経費
        ("気密試験", "ガス設備工事", "式", 65000, "一般"),
        ("耐圧試験", "ガス設備工事", "式", 85000, "高圧"),
        ("ガス漏れ検査", "ガス設備工事", "式", 35000, ""),
        ("諸経費", "ガス設備工事", "式", 180000, "現場管理費含む"),
        ("運搬費", "ガス設備工事", "式", 45000, "資機材"),

        # 安全設備
        ("ガス漏れ警報器", "ガス設備工事", "台", 28000, "都市ガス用"),
        ("緊急遮断弁", "ガス設備工事", "台", 75000, "25A"),
        ("緊急遮断弁", "ガス設備工事", "台", 95000, "50A"),
    ]

    added = 0
    for desc, disc, unit, price, spec in new_items:
        item_id = get_next_id(kb_items, "GAS_EXT")
        kb_items.append(create_kb_item(item_id, desc, disc, unit, price, spec))
        added += 1

    print(f"  追加: {added}件")
    return added

def add_electrical_equipment(kb_items):
    """電気設備項目を追加"""
    print("\n■ 電気設備項目を追加中...")

    new_items = [
        # LED照明
        ("LED照明器具", "電気設備工事", "台", 12000, "40W相当 直管型"),
        ("LED照明器具", "電気設備工事", "台", 18000, "60W相当 直管型"),
        ("LED照明器具", "電気設備工事", "台", 25000, "ベースライト"),
        ("LEDダウンライト", "電気設備工事", "台", 8500, "100φ"),
        ("LEDダウンライト", "電気設備工事", "台", 12000, "150φ"),
        ("LED非常照明", "電気設備工事", "台", 22000, "バッテリー内蔵"),

        # 変圧器
        ("変圧器", "電気設備工事", "台", 350000, "単相 50kVA"),
        ("変圧器", "電気設備工事", "台", 550000, "三相 75kVA"),
        ("変圧器", "電気設備工事", "台", 750000, "三相 100kVA"),
        ("変圧器", "電気設備工事", "台", 1200000, "三相 200kVA"),

        # LAN配線
        ("LAN配線", "電気設備工事", "m", 850, "Cat5e"),
        ("LAN配線", "電気設備工事", "m", 1200, "Cat6"),
        ("LAN配線", "電気設備工事", "m", 1800, "Cat6A"),
        ("情報コンセント", "電気設備工事", "箇所", 4500, "Cat6"),
        ("LANパッチパネル", "電気設備工事", "面", 35000, "24ポート"),

        # 非常照明・誘導灯
        ("非常照明", "電気設備工事", "台", 18000, "LED バッテリー内蔵"),
        ("誘導灯", "電気設備工事", "台", 28000, "B級 片面"),
        ("誘導灯", "電気設備工事", "台", 35000, "B級 両面"),
        ("誘導灯", "電気設備工事", "台", 45000, "A級"),

        # 避雷針
        ("避雷針", "電気設備工事", "式", 250000, "一般建物用"),
        ("避雷導体", "電気設備工事", "m", 3500, "銅テープ"),

        # 配線撤去
        ("配線撤去", "電気設備工事", "m", 450, "一般"),
        ("ケーブル撤去", "電気設備工事", "m", 850, "高圧"),
        ("照明器具撤去", "電気設備工事", "台", 2500, ""),
        ("分電盤撤去", "電気設備工事", "面", 15000, ""),

        # 試験
        ("電気試験", "電気設備工事", "式", 85000, "絶縁抵抗・接地抵抗"),
        ("竣工検査", "電気設備工事", "式", 65000, ""),

        # コンセント追加
        ("コンセント", "電気設備工事", "箇所", 4500, "2P15A"),
        ("コンセント", "電気設備工事", "箇所", 6500, "2P20A"),
        ("OAコンセント", "電気設備工事", "箇所", 8500, "OAフロア用"),
    ]

    added = 0
    for desc, disc, unit, price, spec in new_items:
        item_id = get_next_id(kb_items, "ELEC_EXT")
        kb_items.append(create_kb_item(item_id, desc, disc, unit, price, spec))
        added += 1

    print(f"  追加: {added}件")
    return added

def add_mechanical_equipment(kb_items):
    """機械設備項目を追加"""
    print("\n■ 機械設備項目を追加中...")

    new_items = [
        # 冷媒配管
        ("冷媒配管", "機械設備工事", "m", 3500, "ペアコイル 2分3分"),
        ("冷媒配管", "機械設備工事", "m", 4500, "ペアコイル 2分4分"),
        ("冷媒配管", "機械設備工事", "m", 5500, "ペアコイル 3分5分"),
        ("冷媒配管工事", "機械設備工事", "式", 120000, "一式"),
        ("冷媒チャージ", "機械設備工事", "kg", 8500, "R410A"),
        ("冷媒チャージ", "機械設備工事", "kg", 12000, "R32"),

        # 給水管
        ("給水管", "機械設備工事", "m", 2800, "HIVP 20A"),
        ("給水管", "機械設備工事", "m", 3500, "HIVP 25A"),
        ("給水管", "機械設備工事", "m", 4500, "HIVP 40A"),
        ("給水管", "機械設備工事", "m", 6500, "HIVP 50A"),
        ("給水管", "機械設備工事", "m", 5500, "SUS 20A"),
        ("給水管", "機械設備工事", "m", 7500, "SUS 25A"),

        # 排水管
        ("排水管", "機械設備工事", "m", 2200, "VU 50A"),
        ("排水管", "機械設備工事", "m", 2800, "VU 75A"),
        ("排水管", "機械設備工事", "m", 3500, "VU 100A"),
        ("排水管", "機械設備工事", "m", 4500, "VU 150A"),

        # 衛生器具
        ("大便器", "機械設備工事", "台", 85000, "洋式 一般"),
        ("大便器", "機械設備工事", "台", 150000, "洋式 ウォシュレット付"),
        ("小便器", "機械設備工事", "台", 65000, "壁掛型"),
        ("洗面器", "機械設備工事", "台", 45000, "陶器製"),
        ("洗面化粧台", "機械設備工事", "台", 120000, "W750"),
        ("流し台", "機械設備工事", "台", 85000, "ステンレス W1200"),
        ("手洗器", "機械設備工事", "台", 35000, "小型"),

        # 給湯器
        ("給湯器", "機械設備工事", "台", 180000, "電気温水器 200L"),
        ("給湯器", "機械設備工事", "台", 250000, "ガス給湯器 24号"),
        ("給湯器", "機械設備工事", "台", 450000, "エコキュート 370L"),

        # エアコン追加
        ("エアコン", "機械設備工事", "台", 85000, "ルームエアコン 2.8kW"),
        ("エアコン", "機械設備工事", "台", 120000, "ルームエアコン 4.0kW"),
        ("エアコン", "機械設備工事", "台", 180000, "ルームエアコン 5.6kW"),
        ("天井カセットエアコン", "機械設備工事", "台", 350000, "4方向 5.6kW"),
        ("天井カセットエアコン", "機械設備工事", "台", 450000, "4方向 11.2kW"),

        # 撤去
        ("配管撤去", "機械設備工事", "m", 1200, "給水管"),
        ("配管撤去", "機械設備工事", "m", 1500, "排水管"),
        ("衛生器具撤去", "機械設備工事", "台", 8500, "便器"),
        ("エアコン撤去", "機械設備工事", "台", 15000, "室内機"),
    ]

    added = 0
    for desc, disc, unit, price, spec in new_items:
        item_id = get_next_id(kb_items, "MECH_EXT")
        kb_items.append(create_kb_item(item_id, desc, disc, unit, price, spec))
        added += 1

    print(f"  追加: {added}件")
    return added

def main():
    print("=" * 60)
    print("KB拡充スクリプト")
    print("=" * 60)

    # KBを読み込み
    kb_items = load_kb()
    original_count = len(kb_items)
    print(f"\n元のKB項目数: {original_count}")

    # 工事区分別の現状
    disciplines = {}
    for item in kb_items:
        disc = item.get('discipline', '不明')
        disciplines[disc] = disciplines.get(disc, 0) + 1

    print("\n【拡充前】工事区分別項目数:")
    for disc, count in sorted(disciplines.items(), key=lambda x: -x[1]):
        print(f"  {disc}: {count}件")

    # 項目追加
    total_added = 0
    total_added += add_gas_equipment(kb_items)
    total_added += add_electrical_equipment(kb_items)
    total_added += add_mechanical_equipment(kb_items)

    # 保存
    save_kb(kb_items)

    # 拡充後の統計
    new_disciplines = {}
    for item in kb_items:
        disc = item.get('discipline', '不明')
        new_disciplines[disc] = new_disciplines.get(disc, 0) + 1

    print("\n" + "=" * 60)
    print("【拡充後】工事区分別項目数:")
    for disc, count in sorted(new_disciplines.items(), key=lambda x: -x[1]):
        old_count = disciplines.get(disc, 0)
        diff = count - old_count
        if diff > 0:
            print(f"  {disc}: {count}件 (+{diff})")
        else:
            print(f"  {disc}: {count}件")

    print(f"\n総項目数: {original_count} → {len(kb_items)} (+{total_added})")
    print("=" * 60)

if __name__ == "__main__":
    main()
