# 見積精度向上 実装計画・結果

## 実装完了（2025-11-22）

### Phase 1: Vision抽出による諸元表データ取得 ✅

**テスト結果**:

| 項目 | 結果 |
|------|------|
| 部屋タイプ数 | **79種類** |
| 総部屋数 | **122室** |
| ガス栓総数 | **8箇所** |
| コンセント総数 | **374個** |

**抽出された部屋データ例**:
- 普通教室: 21室, ガス=0, コンセント=4
- 生物室（準備室含む）: 1室, ガス=1, コンセント=4
- 化学室（準備室含む）: 1室, ガス=1, コンセント=4
- 物理室（準備室含む）: 1室, ガス=1, コンセント=4

---

### Phase 2: KBマッチングロジック改善 ✅

**類義語辞書テスト結果**:
- 「高圧気中負荷開閉器（PAS）」→ 6件の類義語にマッチ
- 「キュービクル」→ 4件の類義語にマッチ
- 「架橋ポリエチレンケーブル」→ 6件の類義語にマッチ
- 「空冷ヒートポンプエアコン」→ 6件の類義語にマッチ

**discipline互換性テスト結果**:
- KB=「設備工事」は全ての設備工事にマッチ ✓
- 同じdisciplineはマッチ ✓
- 異なるdisciplineはマッチしない ✓

**単価妥当性チェック結果**:
- キュービクル ¥11,570 → **拒否** ✓（最低100万円）
- キュービクル ¥5,600,000 → **許可** ✓
- 高圧変圧器 ¥11,570 → **拒否** ✓（最低50万円）
- 高圧変圧器 ¥800,000 → **許可** ✓

---

## 実装内容

### 追加された機能

1. **類義語辞書 `SYNONYM_DICT`**
   - 電気設備: 気中開閉器、キュービクル、ケーブル、分電盤、照明等
   - 機械設備: 空調機、換気扇、給水ポンプ、衛生器具等
   - ガス設備: 白ガス管、PE管、ガスコンセント等

2. **高額機器リスト `HIGH_VALUE_ITEMS`**
   - キュービクル: 最低100万円
   - 変圧器: 最低50万円
   - 発電機: 最低200万円
   - エレベーター: 最低500万円

3. **ヘルパーメソッド**
   - `_is_discipline_compatible()`: 工事区分の互換性チェック
   - `_find_synonyms()`: 類義語取得
   - `_validate_price()`: 単価妥当性検証

4. **Vision抽出メソッド**
   - `extract_specification_table_with_vision()`: 諸元表の画像認識

### 変更ファイル

- `pipelines/estimate_generator_ai.py`:
  - 類義語辞書追加（36-60行）
  - 高額機器リスト追加（63-77行）
  - ヘルパーメソッド追加（105-204行）
  - Vision抽出メソッド追加（389-555行）
  - `enrich_with_prices()` 更新（類義語/discipline/価格検証）
  - `generate_estimate()` 更新（Vision抽出統合）

---

## 改善効果

| 指標 | 改善前 | 改善後 |
|------|--------|--------|
| 諸元表抽出 | テキストベース（不正確） | Vision API（正確） |
| discipline互換性 | 完全一致のみ | 緩和版（設備工事→全設備） |
| 類義語マッチング | なし | 辞書ベース |
| 単価妥当性 | チェックなし | 最低価格チェック |

---

## 残課題

### P1（次フェーズ）
1. **KB項目の拡充**: 高額機器の正確な単価データが不足
2. **Phase 3**: 仕様書セクション別抽出
3. **Phase 4**: 図面数量抽出強化

### P2（将来）
1. ベクトル検索によるマッチング精度向上
2. 複数見積からの学習機能
