# KB単価照合フロー

## 概要

見積書作成時に、仕様書から生成された見積項目に対して、KB（ナレッジベース）から単価を自動的に照合・適用する仕組みを説明します。

---

## 全体フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    【入力】                                      │
│  ・仕様書PDF                                                     │
│  ・メール本文PDF                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              【Step 1】テキスト抽出                              │
│  ・PyPDF2でPDFからテキストを抽出                                │
│  ・ページ数制限なし（全ページ処理）                              │
│  ・LLMへは最大60,000文字を送信                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              【Step 2】建物情報抽出                              │
│  ・Claude APIで構造化データに変換                               │
│  ・工事名、場所、面積、階数、期間等                             │
│  ・Vision APIで諸元表から部屋数・設備数を抽出                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              【Step 3】見積項目生成                              │
│  ・Claude APIが建物情報をもとに詳細項目を生成                   │
│  ・工事区分別（電気/機械/ガス）に項目を作成                     │
│  ・この時点では単価は空（null）                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              【Step 4】KB単価照合 ★ここが本題                   │
│  ・生成された各項目に対してKBから単価を検索                     │
│  ・類似度スコアを計算してベストマッチを選択                     │
│  ・単価妥当性チェックを実施                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    【出力】                                      │
│  ・見積書PDF                                                     │
│  ・見積データJSON                                                │
│  ・精度検証レポート                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step 4: KB単価照合の詳細

### 4.1 処理対象の決定

```python
for item in estimate_items:
    # 親項目（level 0）や数量なしはスキップ
    if item.level == 0 or not item.quantity:
        continue

    # 単価照合処理へ
```

### 4.2 テキスト正規化

見積項目とKB項目の比較のため、テキストを正規化：

| 処理 | 例 |
|------|-----|
| 全角→半角 | `（）` → `()` |
| 記号除去 | `・`, `/`, `-` を削除 |
| 空白統一 | 複数空白を1つに |
| 小文字化 | `LED` → `led` |

```python
# 正規化例
"高圧受電設備（キュービクル）" → "高圧受電設備(キュービクル)"
"LED照明器具　40W" → "led照明器具 40w"
```

### 4.3 類義語展開

項目名から関連する類義語を取得：

```python
SYNONYM_DICT = {
    "気中開閉器": ["PAS", "高圧気中負荷開閉器", "高圧気中開閉器"],
    "キュービクル": ["高圧受電設備", "受変電設備", "受電設備"],
    "架橋ポリエチレンケーブル": ["CV", "CVT", "高圧ケーブル"],
    "空冷ヒートポンプ": ["エアコン", "空調機", "ヒートポンプ"],
    # ...
}
```

**例**:
- 入力: `高圧気中負荷開閉器（PAS）`
- 類義語: `["気中開閉器", "PAS", "高圧気中開閉器", ...]`

### 4.4 スコア計算

各KB項目に対してスコアを計算：

| マッチ条件 | スコア |
|-----------|--------|
| 項目名 完全一致 | +2.0 |
| 項目名 類義語一致 | +1.8 |
| 項目名 部分一致 | +1.5 |
| 項目名 単語一致 | +1.0 |
| カテゴリ一致 | +1.0 |
| 仕様 完全一致 | +1.5 |
| サイズ一致（例: 15A） | +1.2 |
| 仕様 部分一致 | +0.8 |
| 単位 一致 | +0.5 |

**最大スコア: 5.0**

### 4.5 discipline互換性チェック

工事区分の互換性を確認：

```python
def _is_discipline_compatible(kb_discipline, item_discipline):
    # 完全一致
    if kb_discipline == item_discipline:
        return True

    # "設備工事" は全ての設備工事にマッチ
    if kb_discipline == "設備工事":
        return True

    # 部分一致
    if kb_discipline in item_discipline:
        return True

    return False
```

| KB discipline | Item discipline | 結果 |
|---------------|-----------------|------|
| 設備工事 | 電気設備工事 | ✓ マッチ |
| 電気設備工事 | 電気設備工事 | ✓ マッチ |
| ガス設備工事 | 電気設備工事 | ✗ 不一致 |

### 4.6 単価妥当性チェック

高額機器に異常に低い単価がマッチしないよう検証：

```python
HIGH_VALUE_ITEMS = {
    "キュービクル": 1000000,      # 最低100万円
    "変圧器": 500000,             # 最低50万円
    "発電機": 2000000,            # 最低200万円
    "エレベーター": 5000000,      # 最低500万円
    "空調機": 100000,             # 最低10万円
    "給水ポンプ": 200000,         # 最低20万円
}
```

**例**:
- `キュービクル` に ¥11,570 がマッチ → **拒否**（最低100万円）
- `キュービクル` に ¥5,600,000 がマッチ → **許可**

### 4.7 単価適用

スコアが閾値以上かつ単価が妥当な場合に適用：

```python
if (best_score >= 1.0) and price_valid:
    item.unit_price = matched_price
    item.amount = item.quantity * item.unit_price
    item.source_reference = f"KB:{kb_item_id}[{match_type}]({score}%)"
```

---

## マッチング例

### 成功例

| 生成された項目 | KB項目 | スコア | 結果 |
|---------------|--------|--------|------|
| 高圧気中負荷開閉器（PAS） | 気中開閉器 | 1.8 | ✓ 類義語マッチ |
| キュービクル 500kVA | キュービクル | 3.5 | ✓ 完全+仕様マッチ |
| LED照明器具 40W | LED照明 | 2.0 | ✓ 部分マッチ |
| 白ガス管 15A | 白ガス管（ネジ接合）15A | 3.7 | ✓ 完全+サイズマッチ |

### 失敗例（単価適用されない）

| 生成された項目 | 理由 |
|---------------|------|
| 高圧変圧器 500kVA | KB単価¥11,570（最低50万円未満で拒否） |
| 特殊配管工事 | KBに該当項目なし |
| エレベーター保守 | discipline不一致 |

---

## KB（ナレッジベース）のデータ構造

```json
{
  "item_id": "ELEC_001",
  "description": "キュービクル",
  "discipline": "設備工事",
  "unit": "面",
  "unit_price": 5600000.0,
  "features": {
    "specification": "1φ3w300KVA、3φ3w400KVA",
    "quantity": 1
  },
  "context_tags": ["学校", "高校", "仮設"]
}
```

---

## KBの更新方法

過去の見積書PDFからKBを構築：

```python
from pipelines.kb_builder import PriceKBBuilder

kb_builder = PriceKBBuilder()

# PDF見積書からKB構築
price_refs = kb_builder.extract_estimate_from_pdf(
    "見積書.pdf",
    project_name="プロジェクトA"
)

# 既存KBとマージ
merged = kb_builder.merge_with_existing_kb(
    price_refs,
    merge_strategy="keep_new"
)

# 保存
kb_builder.save_kb_to_json(merged, "kb/price_kb.json")
```

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `pipelines/estimate_generator_ai.py` | 見積生成・KB照合ロジック |
| `pipelines/kb_builder.py` | KB構築・マージ機能 |
| `kb/price_kb.json` | 単価ナレッジベース |
